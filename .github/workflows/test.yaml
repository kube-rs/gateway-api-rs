name: tests

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - "main"
    tags:
      - "*"
  workflow_dispatch: {}

jobs:
  lockfile:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: regenerate Cargo.lock
        run: cargo generate-lockfile

      - name: check Cargo.lock is up to date
        run: |
          git diff --exit-code -- Cargo.lock || (
            echo "Cargo.lock is out of date or differs from the lockfile Cargo would generate." &&
            echo "Run 'cargo generate-lockfile' (or 'cargo update' if appropriate) and commit the updated Cargo.lock." &&
            exit 1
          )

  generators:
    runs-on: ubuntu-latest
    needs: lockfile
    steps:
      - name: checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: install kopium
        run: cargo install kopium --version 0.22.5

      - name: run generators
        run: make generate

      - name: check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Generator produced changes. Please run 'make generate' locally and commit the results." && exit 1)

  unit-tests:
    runs-on: ubuntu-latest
    needs: generators
    steps:
      - name: checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: run unit tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -v -- --nocapture

  integration-tests:
    runs-on: ubuntu-latest
    needs: [generators, unit-tests]
    steps:
      - name: checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: run integration tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -v -- --nocapture --ignored
